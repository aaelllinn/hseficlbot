import asyncio
import logging
import aiosqlite
import pytz
from datetime import datetime
from aiogram import Bot, Dispatcher, types, F
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
TOKEN = ("7526423092:AAEhJzRO1jDZ6McW7_2H_UtbMJ8kma4O3YA")
if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()
scheduler = AsyncIOScheduler()
dp.data = {}  # –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="üíÖüèª–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—ÉüíÖüèª"), KeyboardButton(text="üëÄ–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏üëÄ")],
        [KeyboardButton(text="üóë–û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—Éüóë"), KeyboardButton(text="üîç–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏üîç")],
        [KeyboardButton(text="üîß–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—Éüîß"), KeyboardButton(text="üéì–£—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏üéì")],
        [KeyboardButton(text="üìà–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞üìà"), KeyboardButton(text="üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ"), KeyboardButton(text="‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ")]
    ],
    resize_keyboard=True
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async def init_db():
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã flashcards
            await db.execute("""
                CREATE TABLE IF NOT EXISTS flashcards (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    question TEXT,
                    answer TEXT,
                    category TEXT
                )
            """)
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å—Ç–æ–ª–±—Ü–∞ category
            cursor = await db.execute("PRAGMA table_info(flashcards)")
            columns = [info[1] for info in await cursor.fetchall()]
            if 'category' not in columns:
                logging.info("–°—Ç–æ–ª–±–µ—Ü 'category' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ")
                await db.execute("ALTER TABLE flashcards ADD COLUMN category TEXT")
                await db.commit()
                logging.info("–°—Ç–æ–ª–±–µ—Ü 'category' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω")

 # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã statistics
            await db.execute("""
                CREATE TABLE IF NOT EXISTS statistics (
                    user_id INTEGER PRIMARY KEY,
                    correct INTEGER DEFAULT 0,
                    incorrect INTEGER DEFAULT 0
                )
            """)
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã reminders
            await db.execute("""
                CREATE TABLE IF NOT EXISTS reminders (
                    user_id INTEGER PRIMARY KEY,
                    enabled INTEGER DEFAULT 0
                )
            """)
            await db.commit()
        logging.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        raise

# –ö–æ–º–∞–Ω–¥–∞ /start
@dp.message(Command("start"))
async def start_command(message: Message):
    logging.info(f"–ö–æ–º–∞–Ω–¥–∞ /start –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    await message.answer("–ü—Ä–∏–≤–µ—Ç!üëãüèª \n\n–Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. \n\n–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üíÖüèª–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—ÉüíÖüèª")
async def add_card_prompt(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    dp.data[message.from_user.id] = {"state": "add_category"}
    await message.answer("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ (–∏–ª–∏ '–û–±—â–µ–µ', –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–º—É):")

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üëÄ–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏üëÄ")
async def show_cards(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute(
                "SELECT category, question, answer FROM flashcards WHERE user_id = ? ORDER BY category",
                (message.from_user.id,))
            cards = await cursor.fetchall()
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if not cards:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.")
        return

    response = ""
    current_category = None
    card_number = 1
    for category, question, answer in cards:
        if category != current_category:
            if current_category is not None:
                response += "\n"
            response += f"<b>üìö –¢–µ–º–∞: {category}</b>\n"
            current_category = category
        response += f"{card_number}. {question} - {answer}\n"
        card_number += 1

    await message.answer(response)

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üóë–û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—Éüóë")
async def delete_card_prompt(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute(
                "SELECT category, question, answer FROM flashcards WHERE user_id = ? ORDER BY category",
                (message.from_user.id,))
            cards = await cursor.fetchall()
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if not cards:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.")
        return

    response = ""
    current_category = None
    card_number = 1
    for category, question, answer in cards:
        if category != current_category:
            response += f"\n<b>üìö –¢–µ–º–∞: {category}</b>\n"
            current_category = category
        response += f"{card_number}. {question} - {answer}\n"
        card_number += 1

   dp.data[message.from_user.id] = {"state": "delete_card"}
    await message.answer(f"–í–∞—à–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:\n{response}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:")

# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üîç–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏üîç")
async def view_card_prompt(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute(
                "SELECT category, question, answer FROM flashcards WHERE user_id = ? ORDER BY category",
                (message.from_user.id,))
            cards = await cursor.fetchall()
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if not cards:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.")
        return

    response = ""
    current_category = None
    card_number = 1
    for category, question, answer in cards:
        if category != current_category:
            response += f"\n<b>üìö –¢–µ–º–∞: {category}</b>\n"
            current_category = category
        response += f"{card_number}. {question} - {answer}\n"
        card_number += 1

    dp.data[message.from_user.id] = {"state": "view_card"}
    await message.answer(f"–í–∞—à–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:\n{response}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:")

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üîß–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—Éüîß")
async def edit_card_prompt(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute(
                "SELECT category, question, answer FROM flashcards WHERE user_id = ? ORDER BY category",
                (message.from_user.id,))
            cards = await cursor.fetchall()
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if not cards:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.")
        return

    response = ""
    current_category = None
    card_number = 1
    for category, question, answer in cards:
        if category != current_category:
            response += f"\n<b>üìö –¢–µ–º–∞: {category}</b>\n"
            current_category = category
        response += f"{card_number}. {question} - {answer}\n"
        card_number += 1

    dp.data[message.from_user.id] = {"state": "edit_card"}
    await message.answer(
        f"–í–∞—à–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:\n{response}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä, –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏ –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ù–æ–º–µ—Ä - –í–æ–ø—Ä–æ—Å - –û—Ç–≤–µ—Ç")

# –£—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
@dp.message(F.text == "üéì–£—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏üéì")
async def learn_cards_prompt(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–£—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    user_id = message.from_user.id
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute(
                "SELECT DISTINCT category FROM flashcards WHERE user_id = ? AND category IS NOT NULL",
                (user_id,))
            categories = [row[0] for row in await cursor.fetchall()]
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if not categories:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –ø–æ–º–æ—â—å—é '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É'. üòä")
        return

    category_keyboard = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=cat)] for cat in categories] + [[KeyboardButton(text="üîô –û—Ç–º–µ–Ω–∞")]],
        resize_keyboard=True,
        one_time_keyboard=True
    )
    dp.data[user_id] = {"state": "learn_select_category"}
    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫:\n\n" +
        "\n".join(f"‚Ä¢ {cat}" for cat in categories),
        reply_markup=category_keyboard
    )

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
@dp.message(F.text == "üìà–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞üìà")
async def show_statistics(message: Message):
    logging.info(f"–ö–Ω–æ–ø–∫–∞ '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' –Ω–∞–∂–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {message.from_user.id}")
    user_id = message.from_user.id
    try:
        async with aiosqlite.connect("flashcards.db") as db:
            cursor = await db.execute("SELECT correct, incorrect FROM statistics WHERE user_id = ?", (user_id,))
            row = await cursor.fetchone()
    except aiosqlite.Error as e:
        logging.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    if row:
        correct, incorrect = row
        total = correct + incorrect
        percent = (correct / total * 100) if total > 0 else 0
        await message.answer(
            f"<b>üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
            f"‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {correct}\n"
            f"‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {incorrect}\n"
            f"üéØ –¢–æ—á–Ω–æ—Å—Ç—å: {percent:.2f}%"
        )
    else:
        await message.answer("–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü—Ä–æ–π–¥–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å.")
